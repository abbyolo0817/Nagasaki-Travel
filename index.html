<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>長崎旅遊小助手 - 欸比 & 歐膩</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Firebase (兼容版 SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Noto+Serif+TC:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #6F7F8C; /* 霧灰藍 */
            color: #F2F2F0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif-aesthetic { font-family: 'Noto Serif TC', serif; }
        .font-italic-aesthetic { font-family: 'Noto Serif TC', serif; font-style: italic; }

        /* 蓋章效果動畫 */
        @keyframes stamp-bang {
            0% { transform: translate(-50%, -50%) rotate(-15deg) scale(5); opacity: 0; }
            80% { transform: translate(-50%, -50%) rotate(-15deg) scale(0.9); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(-15deg) scale(1); opacity: 1; }
        }

        .stamp-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            border: 5px solid #FF4D4D;
            color: #FF4D4D;
            padding: 8px 16px;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            border-radius: 12px;
            z-index: 50;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            animation: stamp-bang 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            font-family: 'Noto Serif TC', serif;
        }

        .content-dimmed {
            opacity: 0.3;
            filter: grayscale(0.8) blur(0.5px);
            transition: all 0.3s ease;
        }

        .texture-felt {
            background-image: url('https://www.transparenttextures.com/patterns/felt.png');
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-zoom { animation: zoomIn 0.3s ease-out; }

        .time-badge {
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCrP8DBTUN4lw95bwseGZTzFqfsK2oUZ2k",
            authDomain: "nagasaki-travel.firebaseapp.com",
            projectId: "nagasaki-travel",
            storageBucket: "nagasaki-travel.firebasestorage.app",
            messagingSenderId: "792460448732",
            appId: "1:792460448732:web:32fe93e3519c97a3a43519",
            measurementId: "G-6LBVHRZGH0"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const targetAppId = 'nagasaki-travel-official';

        const USERS = ["欸比", "歐膩"];

        const Icon = ({ name, size = 20, className = "" }) => {
            const svgProps = {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2.5",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: className
            };

            const paths = {
                Ship: <g><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20.42a2.4 2.4 0 0 0 1.58.58 2.5 2.5 0 0 0 1-.2"/><path d="M3.5 18 2 15l1-1 3.5 1.5 5-2.5 5 2.5 3.5-1.5 1 1-1.5 3"/><path d="M6 13h4V8l-4 3Z"/><path d="M14 13h4l-4-2V8Z"/><path d="M12 13V2"/></g>,
                User: <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                RefreshCcw: <g><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></g>,
                Plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
                Trash2: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
                Edit3: <g><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></g>,
                MapPin: <g><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></g>,
                Navigation: <g><polygon points="3 11 22 2 13 21 11 13 3 11"/></g>,
                MessageSquare: <g><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></g>,
                Send: <g><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></g>,
                CheckCircle2: <g><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></g>,
                Circle: <g><circle cx="12" cy="12" r="10"/></g>,
                Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
                X: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                CheckSquare: <g><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></g>,
                Square: <g><rect width="18" height="18" x="3" y="3" rx="2"/></g>,
                ClipboardList: <g><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></g>,
                Wallet: <g><path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2"/><path d="M16 12h5"/></g>,
                Utensils: <g><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></g>,
                Train: <g><rect width="16" height="15" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M8 15h.01"/><path d="M16 15h.01"/><path d="m6 19-2 3"/><path d="m18 19 2 3"/></g>,
                Bed: <g><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></g>,
                Camera: <g><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></g>
            };

            return (
                <svg {...svgProps}>
                    {paths[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('day1');
            const [itinerary, setItinerary] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [todos, setTodos] = useState([]);
            const [config, setConfig] = useState({ totalDays: 3 });
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState('itinerary'); 
            const [editingId, setEditingId] = useState(null);
            
            const [newItem, setNewItem] = useState({ title: '', location: '', note: '', day: 1, category: '觀光', mapUrl: '', time: '' });
            const [newExpense, setNewExpense] = useState({ desc: '', amount: '', payer: '', abbyPortion: '', unniPortion: '', settled: false, month: '', day: '' });
            const [newTodoTitle, setNewTodoTitle] = useState('');
            const [taskInputs, setTaskInputs] = useState({});
            const [commentText, setCommentText] = useState({});

            const categoryStyles = {
                '餐飲': { bg: 'bg-[#9BA8B4]', icon: 'Utensils' },
                '交通': { bg: 'bg-[#B4AFAB]', icon: 'Train' },
                '住宿': { bg: 'bg-[#7D8A94]', icon: 'Bed' },
                '觀光': { bg: 'bg-[#A29E99]', icon: 'Camera' }
            };

            useEffect(() => {
                auth.signInAnonymously().catch(e => console.error(e));
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const rootRef = db.collection('artifacts').doc(targetAppId).collection('public').doc('data');
                
                const unsubItinerary = rootRef.collection('itinerary').onSnapshot(snap => {
                    setItinerary(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubExpenses = rootRef.collection('expenses').onSnapshot(snap => {
                    setExpenses(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubTodos = rootRef.collection('todos').onSnapshot(snap => {
                    setTodos(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubConfig = rootRef.collection('settings').doc('config').onSnapshot(doc => {
                    if (doc.exists) setConfig(doc.data());
                });

                return () => { unsubItinerary(); unsubExpenses(); unsubTodos(); unsubConfig(); };
            }, [user]);

            // (3) 行程排序邏輯優化：先時間、後建立順序
            const sortedItinerary = useMemo(() => {
                return [...itinerary].sort((a, b) => {
                    const getTimeValue = (str) => {
                        if (!str || typeof str !== 'string') return null;
                        const match = str.match(/\d{1,2}:\d{2}/);
                        if (!match) return null;
                        const parts = match[0].split(':');
                        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
                    };
                    const va = getTimeValue(a.time);
                    const vb = getTimeValue(b.time);
                    
                    if (va !== null && vb !== null) return va - vb;
                    if (va !== null) return -1;
                    if (vb !== null) return 1;
                    // 無時間設定者，依建立時間順序排在最後（最新新增在最下）
                    return (a.createdAt || 0) - (b.createdAt || 0);
                });
            }, [itinerary]);

            // 消費紀錄排序 (最新在最上面)
            const sortedExpenses = useMemo(() => {
                return [...expenses].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            }, [expenses]);

            const saveItem = async () => {
                if (!newItem.title || !user) return;
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('itinerary');
                if (modalType === 'edit_itinerary' && editingId) {
                    await ref.doc(editingId).update(newItem);
                } else {
                    await ref.add({ ...newItem, createdAt: Date.now(), comments: [] });
                }
                closeModal();
            };

            const openEdit = (item) => {
                setNewItem({
                    title: item.title || '',
                    location: item.location || '',
                    note: item.note || '',
                    day: item.day || 1,
                    category: item.category || '觀光',
                    mapUrl: item.mapUrl || '',
                    time: item.time || ''
                });
                setEditingId(item.id);
                setModalType('edit_itinerary');
                setIsModalOpen(true);
            };

            const deleteItem = async (id, type) => {
                await db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection(type).doc(id).delete();
            };

            const postComment = async (itemId) => {
                if (!commentText[itemId] || !user) return;
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('itinerary').doc(itemId);
                const item = itinerary.find(i => i.id === itemId);
                const newComments = [...(item.comments || []), { id: Date.now().toString(), user: currentUser, text: commentText[itemId], time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }];
                await ref.update({ comments: newComments });
                setCommentText({ ...commentText, [itemId]: '' });
            };

            const deleteComment = async (itemId, commentId) => {
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('itinerary').doc(itemId);
                const item = itinerary.find(i => i.id === itemId);
                const newComments = (item.comments || []).filter(c => c.id !== commentId);
                await ref.update({ comments: newComments });
            };

            const saveExpense = async () => {
                if (!newExpense.desc || !newExpense.amount) return;
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('expenses');
                await ref.add({ ...newExpense, amount: Number(newExpense.amount), abbyPortion: Number(newExpense.abbyPortion), unniPortion: Number(newExpense.unniPortion), createdAt: Date.now() });
                closeModal();
            };

            const saveTodo = async () => {
                if (!newTodoTitle) return;
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('todos');
                await ref.add({ title: newTodoTitle, items: [], createdAt: Date.now() });
                closeModal();
            };

            const addTask = async (todoId, text) => {
                if (!text) return;
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('todos').doc(todoId);
                const todo = todos.find(t => t.id === todoId);
                const newItems = [...(todo.items || []), { id: Date.now().toString(), text, completed: false }];
                await ref.update({ items: newItems });
                setTaskInputs({ ...taskInputs, [todoId]: '' });
            };

            const toggleTask = async (todoId, taskId) => {
                const ref = db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('todos').doc(todoId);
                const todo = todos.find(t => t.id === todoId);
                const newItems = todo.items.map(i => i.id === taskId ? { ...i, completed: !i.completed } : i);
                await ref.update({ items: newItems });
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setNewItem({ title: '', location: '', note: '', day: 1, category: '觀光', mapUrl: '', time: '' });
                setNewExpense({ desc: '', amount: '', payer: currentUser, abbyPortion: '', unniPortion: '', settled: false, month: '', day: '' });
                setNewTodoTitle('');
                setEditingId(null);
            };

            const summary = useMemo(() => {
                let uoa = 0, aou = 0;
                expenses.filter(e => !e.settled).forEach(e => {
                    if (e.payer === '欸比') uoa += Number(e.unniPortion || 0);
                    else aou += Number(e.abbyPortion || 0);
                });
                const balance = uoa - aou;
                return { balance: Math.abs(balance), who: balance >= 0 ? '歐膩' : '欸比' };
            }, [expenses]);

            if (!currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-8 bg-[#6F7F8C] text-[#F2F2F0]">
                        <div className="text-center animate-zoom w-full max-w-xs">
                            <div className="w-20 h-20 bg-white/10 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
                                <Icon name="Ship" size={40} />
                            </div>
                            <h1 className="text-4xl leading-none mb-6 font-serif-aesthetic tracking-tighter">Nagasaki.</h1>
                            <div className="space-y-4">
                                {USERS.map(name => (
                                    <button key={name} onClick={() => setCurrentUser(name)} className="w-full py-5 rounded-2xl bg-[#8A857D] font-bold tracking-widest shadow-lg active:scale-95 transition-all border border-white/5">我是 {name}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen relative text-[#F2F2F0] pb-24">
                    <div className="fixed inset-0 opacity-[0.05] texture-felt pointer-events-none"></div>
                    
                    <header className="px-6 pt-12 pb-4 max-w-md mx-auto relative z-10">
                        <div className="flex justify-between items-start mb-8">
                            <h1 className="text-4xl leading-none">
                                <span className="font-italic-aesthetic text-3xl block mb-1 opacity-70">Nagasaki.</span>
                                <span className="font-serif-aesthetic font-bold tracking-tighter">長崎</span>
                            </h1>
                            <div className="text-right">
                                <div className="flex items-center gap-2 bg-white/5 border border-white/10 py-2 px-3 rounded-xl mb-1 shadow-lg backdrop-blur-sm">
                                    <span className="text-[10px] font-black uppercase tracking-wider text-white/60">{currentUser}</span>
                                    <Icon name="User" size={14} className="opacity-60" />
                                </div>
                                <button onClick={() => setCurrentUser(null)} className="text-[9px] opacity-40 uppercase flex items-center gap-1 ml-auto font-bold tracking-widest hover:opacity-100 transition-opacity">
                                    <Icon name="RefreshCcw" size={10} /> 切換帳號
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mb-4">
                            <button onClick={() => setActiveTab('split')} className={`flex items-center justify-center gap-2 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all ${activeTab === 'split' ? 'bg-[#8A857D] shadow-lg scale-105' : 'bg-black/10 opacity-50'}`}><Icon name="Wallet" size={14}/>分帳紀錄</button>
                            <button onClick={() => setActiveTab('todo')} className={`flex items-center justify-center gap-2 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all ${activeTab === 'todo' ? 'bg-[#8A857D] shadow-lg scale-105' : 'bg-black/10 opacity-50'}`}><Icon name="ClipboardList" size={14}/>待辦事項</button>
                        </div>

                        {/* (1) 還原選單列：長條鋪色設計 */}
                        <div className="bg-black/20 p-1.5 rounded-2xl flex gap-2 overflow-x-auto no-scrollbar shadow-inner">
                            {Array.from({ length: config.totalDays || 3 }, (_, i) => (
                                <button key={i} onClick={() => setActiveTab(`day${i+1}`)} className={`flex-none py-3 px-6 rounded-xl text-[10px] font-black tracking-widest transition-all ${activeTab === `day${i+1}` ? 'bg-[#8A857D] shadow-lg text-white' : 'opacity-40 hover:opacity-70'}`}>第 {i+1} 天</button>
                            ))}
                        </div>
                    </header>

                    <main className="px-6 max-w-md mx-auto relative z-10">
                        {activeTab.startsWith('day') && (
                            <div className="space-y-6 animate-zoom">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-xl font-bold flex items-center gap-3">
                                        <div className="bg-[#8A857D] w-10 h-10 rounded-lg flex items-center justify-center font-serif-aesthetic shadow-inner border border-white/10">{activeTab.replace('day', '')}</div>
                                        <span className="tracking-tight">第 {activeTab.replace('day', '')} 天 行程</span>
                                    </h2>
                                    {activeTab === `day${config.totalDays}` && <button onClick={() => db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('settings').doc('config').update({ totalDays: config.totalDays + 1 })} className="text-[10px] opacity-40 font-bold uppercase tracking-widest">+ 增加天數</button>}
                                </div>
                                {sortedItinerary.filter(i => i.day === parseInt(activeTab.replace('day',''))).map(item => (
                                    <div key={item.id} className="bg-[#8A857D] rounded-[2rem] p-6 shadow-xl border border-white/5 relative overflow-hidden transition-all hover:shadow-2xl">
                                        <div className="flex justify-between mb-4">
                                            {/* (3) 修復卡片標籤圖示 */}
                                            <div className="bg-white/10 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-1.5 shadow-sm">
                                                <Icon name={categoryStyles[item.category]?.icon || 'Camera'} size={12}/>
                                                {item.category || '觀光'}
                                            </div>
                                            <div className="flex gap-3 opacity-30">
                                                {/* (2) 修復編輯功能 */}
                                                <button onClick={() => openEdit(item)} className="p-1 active:scale-90 transition-transform"><Icon name="Edit3" size={16}/></button>
                                                <button onClick={() => deleteItem(item.id, 'itinerary')} className="p-1 active:scale-90 transition-transform"><Icon name="Trash2" size={16}/></button>
                                            </div>
                                        </div>
                                        {item.time && <div className="flex items-center gap-1.5 mb-2"><Icon name="Clock" size={12} className="opacity-40" /><span className="time-badge">{item.time}</span></div>}
                                        <h3 className="text-lg font-bold mb-2 leading-tight tracking-tight">{item.title}</h3>
                                        <div className="flex items-center gap-3 text-white/50 text-xs mb-4">
                                            <div className="flex-1 truncate flex items-center gap-1"><Icon name="MapPin" size={14}/>{item.location}</div>
                                            <div className="flex gap-2">
                                                {/* (1) & (2) 只在有連結時顯示，且修正點擊反應 */}
                                                {item.mapUrl && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); window.open(item.mapUrl, '_blank'); }} 
                                                        className="w-10 h-10 bg-blue-500/30 rounded-full flex items-center justify-center shadow-lg active:scale-75 transition-all border border-blue-400/20"
                                                    >
                                                        <Icon name="Navigation" size={18} className="text-blue-100" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        {item.note && <div className="bg-black/10 p-4 rounded-2xl text-[11px] opacity-70 italic mb-4 leading-relaxed">{item.note}</div>}
                                        <div className="pt-4 border-t border-white/5">
                                            <div className="flex items-center gap-2 mb-3 text-[10px] font-black uppercase tracking-widest text-white/30"><Icon name="MessageSquare" size={12} /> 留言板</div>
                                            <div className="space-y-2 mb-4 max-h-40 overflow-y-auto custom-scrollbar">
                                                {(item.comments || []).map(c => (
                                                    <div key={c.id} className={`flex flex-col ${c.user === currentUser ? 'items-end' : 'items-start'}`}>
                                                        <div className="flex items-center gap-2 group max-w-[90%]">
                                                            {c.user === currentUser && <button onClick={() => deleteComment(item.id, c.id)} className="opacity-0 group-hover:opacity-20 transition-opacity p-1"><Icon name="X" size={10}/></button>}
                                                            <div className={`px-3 py-1.5 rounded-2xl text-[11px] shadow-sm ${c.user === currentUser ? 'bg-blue-500/30 rounded-tr-none text-white' : 'bg-white/10 rounded-tl-none text-white/80'}`}>{c.text}</div>
                                                            {c.user !== currentUser && <button onClick={() => deleteComment(item.id, c.id)} className="opacity-0 group-hover:opacity-20 transition-opacity p-1"><Icon name="X" size={10}/></button>}
                                                        </div>
                                                        <span className="text-[8px] opacity-20 mt-1 font-bold tracking-widest px-1">{c.user}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="flex gap-2 items-center flex-nowrap">
                                                <input value={commentText[item.id] || ''} onChange={e => setCommentText({...commentText, [item.id]: e.target.value})} placeholder="說點什麼..." className="flex-1 bg-white/5 border-none rounded-xl px-4 py-3 text-xs outline-none focus:bg-white/10 transition-colors min-w-0" onKeyDown={e => e.key === 'Enter' && postComment(item.id)} />
                                                <button onClick={() => postComment(item.id)} className="flex-shrink-0 w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center active:scale-90 transition-transform"><Icon name="Send" size={14}/></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'split' && (
                            <div className="space-y-6 animate-zoom">
                                <div className="bg-[#8A857D] p-8 rounded-[2.5rem] shadow-2xl border border-white/10 text-center relative overflow-hidden">
                                    <div className="absolute inset-0 opacity-[0.05] texture-felt pointer-events-none"></div>
                                    <p className="text-[10px] opacity-40 uppercase tracking-[0.4em] mb-4 font-black text-center">目前結算摘要</p>
                                    <div className="flex justify-around items-center mb-6 relative z-10 text-center">
                                        <div><p className="text-[10px] opacity-40 mb-1 font-bold uppercase">歐膩付了</p><p className="text-xl font-black">¥{expenses.filter(e=>e.payer==='歐膩').reduce((acc,curr)=>acc+Number(curr.amount),0).toLocaleString()}</p></div>
                                        <div className="w-[1px] h-8 bg-white/10"></div>
                                        <div><p className="text-[10px] opacity-40 mb-1 font-bold uppercase">欸比付了</p><p className="text-xl font-black">¥{expenses.filter(e=>e.payer==='欸比').reduce((acc,curr)=>acc+Number(curr.amount),0).toLocaleString()}</p></div>
                                    </div>
                                    <div className="bg-black/20 p-5 rounded-3xl text-center relative z-10 shadow-inner">
                                        <h2 className="text-xl font-black tracking-tight">{summary.balance === 0 ? "全部結清囉！" : `${summary.who} 還需支付 ¥${summary.balance.toLocaleString()}`}</h2>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <h4 className="text-[10px] opacity-30 uppercase tracking-[0.3em] font-black ml-4">消費清單 (最新在前)</h4>
                                    {sortedExpenses.map(exp => (
                                        <div key={exp.id} className="relative group">
                                            <div className={`bg-[#8A857D] p-5 rounded-[2rem] border border-white/5 shadow-lg transition-all ${exp.settled ? 'content-dimmed' : ''}`}>
                                                <div className="flex justify-between items-start mb-3 relative z-10">
                                                    <div className="flex items-center gap-4">
                                                        <button onClick={() => db.collection('artifacts').doc(targetAppId).collection('public').doc('data').collection('expenses').doc(exp.id).update({ settled: !exp.settled })} className="active:scale-75 transition-transform"><Icon name={exp.settled ? "CheckCircle2" : "Circle"} className={exp.settled ? "text-green-400" : "opacity-20"} size={24}/></button>
                                                        <div>
                                                            <div className="flex items-center gap-2 mb-0.5"><span className="text-[9px] bg-white/10 px-2 py-0.5 rounded font-black opacity-60">{exp.month}/{exp.day}</span><p className="font-bold text-sm tracking-tight">{exp.desc}</p></div>
                                                            <p className="text-[10px] opacity-40 font-bold uppercase tracking-widest">{exp.payer} 付了 ¥{Number(exp.amount).toLocaleString()}</p>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteItem(exp.id, 'expenses')} className="opacity-10 hover:opacity-100 transition-opacity p-1"><Icon name="X" size={16}/></button>
                                                </div>
                                                <div className="flex gap-4 text-[10px] opacity-40 border-t border-white/5 pt-3 font-bold tracking-[0.1em] relative z-10">
                                                    <div className="flex-1">欸比份額: ¥{Number(exp.abbyPortion || 0).toLocaleString()}</div>
                                                    <div className="flex-1">歐膩份額: ¥{Number(exp.unniPortion || 0).toLocaleString()}</div>
                                                </div>
                                            </div>
                                            {exp.settled && <div className="stamp-mark font-serif-aesthetic">已付款</div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'todo' && (
                            <div className="space-y-6 animate-zoom">
                                <h2 className="text-xl font-bold flex items-center gap-3 tracking-tight"><Icon name="ClipboardList" size={24}/>待辦清單</h2>
                                {todos.sort((a,b) => b.createdAt - a.createdAt).map(todo => (
                                    <div key={todo.id} className="bg-[#8A857D] rounded-[2rem] p-6 shadow-xl border border-white/5">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-bold font-serif-aesthetic tracking-tight">{todo.title}</h3>
                                            <button onClick={() => deleteItem(todo.id, 'todos')} className="opacity-20 hover:opacity-100 transition-opacity p-1"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                        <div className="space-y-3 mb-6">
                                            {(todo.items || []).map(task => (
                                                <div key={task.id} className="flex items-center gap-3 cursor-pointer group active:scale-[0.98] transition-transform" onClick={() => toggleTask(todo.id, task.id)}>
                                                    <Icon name={task.completed ? "CheckSquare" : "Square"} className={task.completed ? "text-green-400" : "opacity-30"} size={20}/>
                                                    <span className={`text-sm tracking-tight ${task.completed ? 'line-through opacity-30' : 'opacity-80'}`}>{task.text}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="relative">
                                            <input value={taskInputs[todo.id] || ''} onChange={e => setTaskInputs({...taskInputs, [todo.id]: e.target.value})} placeholder="新增細項..." className="w-full bg-black/10 rounded-xl px-4 py-3 text-xs outline-none border border-white/5 pr-10 focus:bg-black/20 transition-colors" onKeyDown={e => e.key === 'Enter' && addTask(todo.id, e.target.value)} />
                                            <button onClick={() => addTask(todo.id, taskInputs[todo.id])} className="absolute right-3 top-1/2 -translate-y-1/2 opacity-30 hover:opacity-100 active:scale-90 transition-all p-1"><Icon name="Plus" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 右下角大新增按鈕：高對比色 */}
                    <button onClick={() => { 
                        if (activeTab === 'split') setModalType('expense');
                        else if (activeTab === 'todo') setModalType('todo');
                        else setModalType('itinerary');
                        setIsModalOpen(true); 
                    }} className="fixed bottom-8 right-6 w-16 h-16 bg-[#B5AEA4] rounded-[2.2rem] flex items-center justify-center shadow-[0_10px_40px_rgba(0,0,0,0.4)] z-30 active:scale-90 transition-all border-4 border-black/5 ring-4 ring-white/5">
                        <Icon name="Plus" size={32} className="text-[#3A434D]" />
                    </button>

                    {/* MODAL 彈窗 */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-md z-[110] flex items-end justify-center px-4 animate-in fade-in duration-300" onClick={e => e.target === e.currentTarget && closeModal()}>
                            <div className="bg-[#6F7F8C] w-full max-w-md rounded-t-[3rem] p-10 space-y-6 shadow-2xl max-h-[85vh] overflow-y-auto no-scrollbar animate-in slide-in-from-bottom duration-500 border-t border-white/10 text-[#F2F2F0]">
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="text-2xl font-light tracking-tighter uppercase">
                                        {modalType === 'todo' ? '建立清單' : modalType.includes('itinerary') ? (editingId ? '修改行程' : '新增行程') : '新增支出紀錄'}
                                    </h2>
                                    <button onClick={closeModal} className="bg-white/5 w-10 h-10 rounded-full flex items-center justify-center opacity-40 hover:opacity-100 active:scale-90 transition-all shadow-lg"><Icon name="X" size={20}/></button>
                                </div>

                                {modalType === 'todo' ? (
                                    <div className="space-y-4">
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">清單標題</label><input placeholder="例如：藥妝購物清單" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newTodoTitle} onChange={e => setNewTodoTitle(e.target.value)} onKeyDown={e => e.key === 'Enter' && saveTodo()} /></div>
                                        <button onClick={saveTodo} className="w-full py-5 rounded-2xl bg-[#8A857D] font-black text-xs uppercase tracking-[0.3em] shadow-xl active:scale-95 transition-all mt-4 border border-white/5">確認建立</button>
                                    </div>
                                ) : modalType.includes('itinerary') ? (
                                    <div className="space-y-4">
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">行程標題</label><input placeholder="要做什麼？" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})} /></div>
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">行程時間 (09:00 ~ 11:00)</label><input placeholder="會依照此時間自動排序" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10 text-sm" value={newItem.time} onChange={e => setNewItem({...newItem, time: e.target.value})} /></div>
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">地點名稱</label><input placeholder="Google 地圖搜尋用" className="w-full bg-white/5 rounded-2xl p-4 text-sm outline-none border border-white/5 focus:bg-white/10" value={newItem.location} onChange={e => setNewItem({...newItem, location: e.target.value})} /></div>
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest text-blue-300">導航連結 (可選)</label><input placeholder="Google Maps 分享網址" className="w-full bg-white/5 rounded-2xl p-4 text-xs outline-none border border-white/5 focus:bg-white/10" value={newItem.mapUrl} onChange={e => setNewItem({...newItem, mapUrl: e.target.value})} /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">日期天數</label><select className="w-full bg-white/5 rounded-2xl p-4 text-white appearance-none outline-none border border-white/5" value={newItem.day} onChange={e => setNewItem({...newItem, day: parseInt(e.target.value)})}>{Array.from({ length: config.totalDays }, (_, i) => <option key={i} value={i+1} className="text-black">第 {i+1} 天</option>)}</select></div>
                                            <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">分類標籤</label><select className="w-full bg-white/5 rounded-2xl p-4 text-white appearance-none outline-none border border-white/5" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}>
                                                {Object.keys(categoryStyles).map(cat => <option key={cat} value={cat} className="text-black">{cat}</option>)}
                                            </select></div>
                                        </div>
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black uppercase ml-2 tracking-widest">備註筆記</label><textarea placeholder="有什麼要提醒彼此的？" className="w-full bg-white/5 rounded-2xl p-4 h-24 outline-none border border-white/5 focus:bg-white/10 text-sm" value={newItem.note} onChange={e => setNewItem({...newItem, note: e.target.value})} /></div>
                                        <button onClick={saveItem} className="w-full py-5 rounded-2xl bg-[#8A857D] font-black text-xs uppercase tracking-[0.3em] shadow-xl active:scale-95 transition-all mt-4 border border-white/5">確認儲存</button>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest">消費月份</label><input type="number" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newExpense.month} onChange={e => setNewExpense({...newExpense, month: e.target.value})} /></div>
                                            <div className="space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest">日期</label><input type="number" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newExpense.day} onChange={e => setNewExpense({...newExpense, day: e.target.value})} /></div>
                                        </div>
                                        <div className="space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest">項目內容</label><input placeholder="例如：強棒麵午餐" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newExpense.desc} onChange={e => setNewExpense({...newExpense, desc: e.target.value})} /></div>
                                        <div className="flex gap-4">
                                            <div className="flex-1 space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest text-blue-200">總金額 (JPY)</label><input type="number" placeholder="¥" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10 font-bold" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} /></div>
                                            <div className="w-32 space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest">誰付的錢？</label><select className="w-full bg-white/5 rounded-2xl p-4 appearance-none outline-none border border-white/5" value={newExpense.payer} onChange={e => setNewExpense({...newExpense, payer: e.target.value})}><option value="欸比" className="text-black">欸比付</option><option value="歐膩" className="text-black">歐膩付</option></select></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest">欸比應付</label><input type="number" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newExpense.abbyPortion} onChange={e => setNewExpense({...newExpense, abbyPortion: e.target.value})} /></div>
                                            <div className="space-y-1"><label className="text-[10px] opacity-30 font-black ml-2 uppercase tracking-widest">歐膩應付</label><input type="number" className="w-full bg-white/5 rounded-2xl p-4 outline-none border border-white/5 focus:bg-white/10" value={newExpense.unniPortion} onChange={e => setNewExpense({...newExpense, unniPortion: e.target.value})} /></div>
                                        </div>
                                        <button onClick={saveExpense} className="w-full py-5 rounded-2xl bg-[#8A857D] font-black text-xs uppercase tracking-[0.3em] shadow-xl active:scale-95 transition-all mt-4 border border-white/5">記錄這一筆</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
